<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>WildFly 8 Cluster Howto</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta content="Scroll Wiki Publisher" name="generator"/>
    <link rel="stylesheet" href="css/content-style.css" type="text/css"/>
</head>
<body>
    <div class="container">
        <div id="title" class="prepend-top">
              <h1>WildFly 8 Cluster Howto</h1>
        </div>
        
        <div id="66322836" class="content prepend-top">
<ul class=" "><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Preparation%26Scenario">Preparation &amp; Scenario</a>            </p>
    <ul class=" "><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Preparation">Preparation</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Scenario">Scenario</a>            </p>
    </li></ul></li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-DownloadWildFly8">Download WildFly 8</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-DomainConfiguration">Domain Configuration</a>            </p>
    <ul class=" "><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Interfaceconfigonmaster">Interface config on master</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Interfaceconfigonslave">Interface config on slave</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-SecurityConfiguration">Security Configuration</a>            </p>
    <ul class=" "><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Master">Master</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Slave">Slave</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-DryRun">Dry Run</a>            </p>
    </li></ul></li></ul></li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Deployment">Deployment</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-ClusterConfiguration">Cluster Configuration</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-Testing">Testing</a>            </p>
    </li><li class=" ">            <p>
    <a href="66322836.html#66322836_WildFly8ClusterHowto-SpecialThanks">Special Thanks</a>            </p>
    </li></ul>            <p>
    In this article, I'd like to show you how to setup WildFly 8 in domain mode and enable clustering so we could get HA and session replication among the nodes. It's a step to step guide so you can follow the instructions in this article and build the sandbox by yourself     <img src="images/author/images/icons/emoticons/109556488.gif" alt="images/author/images/icons/emoticons/109556488.gif" />
            </p>
        <div class="section-2"  id="66322836_WildFly8ClusterHowto-Preparation%26Scenario"  >
        <h2>Preparation &amp; Scenario</h2>
    
    <div class="section-3"  id="66322836_WildFly8ClusterHowto-Preparation"  >
        <h3>Preparation</h3>
    
            <p>
    We need to prepare two hosts (or virtual hosts) to do the experiment. We will use these two hosts as following:            </p>
    <ul class="alternate "><li class=" ">            <p>
    Install Fedora 16 on them (Other linux version may also fine but I'll use Fedora 16 in this article)            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    Make sure that they are in same local network            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    Make sure that they can access each other via different TCP/UDP ports(better turn off firewall and disable SELinux during the experiment or they will cause network problems).            </p>
    </li></ul>    </div>
    
    <div class="section-3"  id="66322836_WildFly8ClusterHowto-Scenario"  >
        <h3>Scenario</h3>
    
            <p>
    Here are some details on what we are going to do:            </p>
    <ul class="alternate "><li class=" ">            <p>
    Let's call one host as 'master', the other one as 'slave'.            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    Both master and slave will run WildFly 8, and master will run as domain controller, slave will under the domain management of master.            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    Apache httpd will be run on master, and in httpd we will enable the mod_cluster module. The WildFly 8 on master and slave will form a cluster and discovered by httpd.            </p>
    </li></ul>            <p>
        <img src="images/author/download/attachments/66322836/-2061211704.jpg" alt="images/author/download/attachments/66322836/-2061211704.jpg" />
                </p>
    <ul class="alternate "><li class=" ">            <p>
    We will deploy a demo project into domain, and verify that the project is deployed into both master and slave by domain controller. Thus we could see that domain management provide us a single point to manage the deployments across multiple hosts in a single domain.            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    We will access the cluster URL and verify that httpd has distributed the request to one of the WildFly host. So we could see the cluster is working properly.            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    We will try to make a request on cluster, and if the request is forwarded to master, we then kill the WildFly process on master. After that we will go on requesting cluster and we should see the request is forwarded to slave, but the session is not lost. Our goal is to verify the HA is working and sessions are replicated.            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    After previous step finished, we reconnect the master by restarting it. We should see the master is registered back into cluster, also we should see slave sees master as domain controller again and connect to it.            </p>
    </li></ul>            <p>
        <img src="images/author/download/attachments/66322836/-2019335011.jpg" alt="images/author/download/attachments/66322836/-2019335011.jpg" />
                </p>
                <p>
    Please don't worry if you cannot digest so many details currently. Let's move on and you will get the points step by step.            </p>
        </div>
    
    </div>
    
    <div class="section-2"  id="66322836_WildFly8ClusterHowto-DownloadWildFly8"  >
        <h2>Download WildFly 8</h2>
    
            <p>
    First we should download WildFly 8 from the website:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://www.jboss.org/jbossas/downloads/</code></pre>
        </div>
    </div>
            <p>
    The version I downloaded is JBoss AS 7.1.0.CR1b, please don't use the version prior to this one, or you will meet this bug when running in clustering mode:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>https://issues.jboss.org/browse/AS7-2738</code></pre>
        </div>
    </div>
            <p>
    After download finished, I got the zip file:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>jboss-as-7.1.0.CR1b.zip</code></pre>
        </div>
    </div>
            <p>
    Note: The name of your archive will differ slightly due to version naming conventions.<br/>Then I unzipped the package to master and try to make a test run:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>unzip jboss-as-7.1.0.CR1b.zip
cd jboss-as-7.1.0.CR1b/bin
./domain.sh</code></pre>
        </div>
    </div>
            <p>
    If everything ok we should see WildFly successfully startup in domain mode:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>jboss-as-7.1.0.CR1b/bin$ ./domain.sh
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /Users/weli/Downloads/jboss-as-7.1.0.CR1b

  JAVA: /Library/Java/Home/bin/java

  JAVA_OPTS: -Xms64m -Xmx512m -XX:MaxPermSize=256m -Djava.net.preferIPv4Stack=true -Dorg.jboss.resolver.warning=true -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000 -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true

=========================================================================
...

[Server:server-two] 16:59:55,870 INFO  [org.jboss.as] (Controller Boot Thread) JBoss AS 7.1.0.CR1b &quot;Flux Capacitor&quot; started in 2499ms - Started 148 of 214 services (64 services are passive or on-demand)</code></pre>
        </div>
    </div>
            <p>
    Now exit master and let's repeat the same steps on slave host. Finally we get WildFly 8 run on both master and slave, then we could move on to next step.            </p>
        </div>
    
    <div class="section-2"  id="66322836_WildFly8ClusterHowto-DomainConfiguration"  >
        <h2>Domain Configuration</h2>
    
    <div class="section-3"  id="66322836_WildFly8ClusterHowto-Interfaceconfigonmaster"  >
        <h3>Interface config on master</h3>
    
            <p>
    In this section we'll setup both master and slave for them to run in domain mode. And we will configure master to be the domain controller.            </p>
                <p>
    First open the host.xml in master for editing:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>vi domain/configuration/host.xml</code></pre>
        </div>
    </div>
            <p>
    The default settings for interface in this file is like:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;interfaces&gt;
    &lt;interface name=&quot;management&quot;&gt;
        &lt;inet-address value=&quot;${jboss.bind.address.management:127.0.0.1}&quot;/&gt;
    &lt;/interface&gt;
    &lt;interface name=&quot;public&quot;&gt;
       &lt;inet-address value=&quot;${jboss.bind.address:127.0.0.1}&quot;/&gt;
    &lt;/interface&gt;
    &lt;interface name=&quot;unsecured&quot;&gt;      &nbsp;
       &lt;inet-address value=&quot;127.0.0.1&quot; /&gt;   &nbsp;
    &lt;/interface&gt;
&lt;/interfaces&gt;</code></pre>
        </div>
    </div>
            <p>
    We need to change the address to the management interface so slave could connect to master. The public interface allows the application to be accessed by non-local HTTP, and the unsecured interface allows remote RMI access. My master's ip address is 10.211.55.7, so I change the config to:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;interfaces&gt;
    &lt;interface name=&quot;management&quot;
        &lt;inet-address value=&quot;${jboss.bind.address.management:10.211.55.7}&quot;/&gt;
    &lt;/interface&gt;
    &lt;interface name=&quot;public&quot;&gt;
       &lt;inet-address value=&quot;${jboss.bind.address:10.211.55.7}&quot;/&gt;
    &lt;/interface&gt;   &nbsp;
    &lt;interface name=&quot;unsecured&quot;&gt;
       &lt;inet-address value=&quot;10.211.55.7&quot; /&gt;   &nbsp;
    &lt;/interface&gt;
&lt;/interfaces&gt;&nbsp;</code></pre>
        </div>
    </div>
    <div class="confbox programlisting">
                <div class="content">
        <pre><code></code></pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="66322836_WildFly8ClusterHowto-Interfaceconfigonslave"  >
        <h3>Interface config on slave</h3>
    
            <p>
    Now we will setup interfaces on slave. First we need to remove the domain.xml from slave, because slave will not act as domain controller and it will under the management of master. I just rename the domain.xml so it won't be processed by WildFly:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>mv domain/configuration/domain.xml domain/configuration/domain.xml.move</code></pre>
        </div>
    </div>
    <div class="confbox admonition admonition-note">
        
            <p>
    From JBoss AS 7.1.Final you don't need to rename domain.xml anymore.            </p>
        </div>
    
            <p>
    Then let's edit host.xml. Similar to the steps on master, open host.xml first:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>vi domain/configuration/host.xml</code></pre>
        </div>
    </div>
            <p>
    The configuration we'll use on slave is a little bit different, because we need to let slave connect to master. First we need to set the hostname. We change the name property from:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;host name=&quot;master&quot; xmlns=&quot;urn:jboss:domain:1.1&quot;&gt;</code></pre>
        </div>
    </div>
            <p>
    to:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;host name=&quot;slave&quot; xmlns=&quot;urn:jboss:domain:1.1&quot;&gt;</code></pre>
        </div>
    </div>
            <p>
    Then we need to modify domain-controller section so slave can connect to master's management port:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;domain-controller&gt;
   &lt;remote host=&quot;10.211.55.7&quot; port=&quot;9999&quot;/&gt;
&lt;/domain-controller&gt;</code></pre>
        </div>
    </div>
            <p>
    As we know, 10.211.55.7 is the ip address of master.            </p>
                <p>
    Finally, we also need to configure interfaces section and expose the management ports to public address:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;interfaces&gt;
    &lt;interface name=&quot;management&quot;&gt;
        &lt;inet-address value=&quot;${jboss.bind.address.management:10.211.55.2}&quot;/&gt;
    &lt;/interface&gt;
    &lt;interface name=&quot;public&quot;&gt;
       &lt;inet-address value=&quot;${jboss.bind.address:10.211.55.2}&quot;/&gt;
    &lt;/interface&gt;
    &lt;interface name=&quot;unsecured&quot;&gt;      &nbsp;
       &lt;inet-address value=&quot;10.211.55.2&quot; /&gt;   &nbsp;
    &lt;/interface&gt;
&lt;/interfaces&gt;</code></pre>
        </div>
    </div>
            <p>
    10.211.55.2 is the ip address of the slave. Refer to the domain controller configuration above for an explanation of the management, public, and unsecured interfaces.            </p>
        <div class="confbox admonition admonition-note">
        
            <p>
    It is easier to turn off all firewalls for testing, but in production, you need to enable the firewall and allow access to the following ports: TBD            </p>
        </div>
    
    </div>
    
    <div class="section-3"  id="66322836_WildFly8ClusterHowto-SecurityConfiguration"  >
        <h3>Security Configuration</h3>
    
            <p>
    If you start WildFly on both master and slave now, you will see the slave cannot be started with following error:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>[Host Controller] 20:31:24,575 ERROR [org.jboss.remoting.remote] (Remoting &quot;endpoint&quot; read-1) JBREM000200: Remote connection failed: javax.security.sasl.SaslException: Authentication failed: all available authentication mechanisms failed
[Host Controller] 20:31:24,579 WARN  [org.jboss.as.host.controller] (Controller Boot Thread) JBAS010900: Could not connect to remote domain controller 10.211.55.7:9999
[Host Controller] 20:31:24,582 ERROR [org.jboss.as.host.controller] (Controller Boot Thread) JBAS010901: Could not connect to master. Aborting. Error was: java.lang.IllegalStateException: JBAS010942: Unable to connect due to authentication failure.</code></pre>
        </div>
    </div>
            <p>
    Because we haven't properly set up the authentication between master and slave. Now let's work on it:            </p>
        <div class="section-4"  id="66322836_WildFly8ClusterHowto-Master"  >
        <h4>Master</h4>
    
            <p>
    In bin directory there is a script called add-user.sh, we'll use it to add new users to the properties file used for domain management authentication:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>./add-user.sh

Enter the details of the new user to add.
Realm (ManagementRealm) :
Username : admin
Password : 123123
Re-enter Password : 123123
The username 'admin' is easy to guess
Are you sure you want to add user 'admin' yes/no? yes
About to add user 'admin' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'admin' to file '/home/weli/projs/jboss-as-7.1.0.CR1b/standalone/configuration/mgmt-users.properties'
Added user 'admin' to file '/home/weli/projs/jboss-as-7.1.0.CR1b/domain/configuration/mgmt-users.properties'</code></pre>
        </div>
    </div>
            <p>
    As shown above, we have created a user named 'admin' and its password is '123123'. Then we add another user called 'slave':            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>./add-user.sh

Enter the details of the new user to add.
Realm (ManagementRealm) :
Username : slave
Password : 123123
Re-enter Password : 123123
About to add user 'slave' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'slave' to file '/home/weli/projs/jboss-as-7.1.0.CR1b/standalone/configuration/mgmt-users.properties'
Added user 'slave' to file '/home/weli/projs/jboss-as-7.1.0.CR1b/domain/configuration/mgmt-users.properties'</code></pre>
        </div>
    </div>
            <p>
    We will use this user for slave host to connect to master.            </p>
        <div class="confbox admonition admonition-note">
        
            <p>
    Notice that the username must be equal to the name given in the slaves host element. That mean for each additional host you need a user.            </p>
        </div>
    
            <p>
    In newer version of WildFly, the add-user.sh will let you choose the type of the user. Here we need to choose 'Management User' type for both 'admin' and 'slave' account:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>./add-user.sh   What type of user do you wish to add?
 a) Management User (mgmt-users.properties)
 b) Application User (application-user.properties)
 (a):</code></pre>
        </div>
    </div>
    </div>
    
    <div class="section-4"  id="66322836_WildFly8ClusterHowto-Slave"  >
        <h4>Slave</h4>
    
            <p>
    In slave we need to configure host.xml for authentication. We should change the security-realms section as following:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;security-realms&gt;
   &lt;security-realm name=&quot;ManagementRealm&quot;&gt;
       &lt;server-identities&gt;
           &lt;secret value=&quot;MTIzMTIz=&quot;/&gt;
       &lt;/server-identities&gt;
       &lt;authentication&gt;
           &lt;properties path=&quot;mgmt-users.properties&quot; relative-to=&quot;jboss.domain.config.dir&quot;/&gt;
       &lt;/authentication&gt;
   &lt;/security-realm&gt;
&lt;/security-realms&gt;</code></pre>
        </div>
    </div>
            <p>
    We've added server-identities into security-realm, which is used for authentication host when slave tries to connect to master. Because the slave's host name is set as 'slave', so we should use the 'slave' user's password on master. In secret value property we have 'MTIzMTIz=', which is the base64 code for '123123'. You can generate this value by using a base64 calculator such as the one at&nbsp;<a href="http://www.webutils.pl/index.php?idx=base64">http://www.webutils.pl/index.php?idx=base64</a>.            </p>
                <p>
    Then in domain controller section we also need to add security-realm property:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;domain-controller&gt;
   &lt;remote host=&quot;10.211.55.7&quot; port=&quot;9999&quot; security-realm=&quot;ManagementRealm&quot;/&gt;
&lt;/domain-controller&gt;</code></pre>
        </div>
    </div>
            <p>
    So the slave host could use the authentication information we provided in 'ManagementRealm'.            </p>
        </div>
    
    <div class="section-4"  id="66322836_WildFly8ClusterHowto-DryRun"  >
        <h4>Dry Run</h4>
    
            <p>
    Now everything is set for the two hosts to run in domain mode. Let's start them by running domain.sh on both hosts. If everything goes fine, we could see from the log on master:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>[Host Controller] 21:30:52,042 INFO  [org.jboss.as.domain] (management-handler-threads - 1) JBAS010918: Registered remote slave host slave</code></pre>
        </div>
    </div>
            <p>
    That means all the configurations are correct and two hosts are run in domain mode now as expected.  Hurrah!            </p>
        </div>
    
    </div>
    
    </div>
    
    <div class="section-2"  id="66322836_WildFly8ClusterHowto-Deployment"  >
        <h2>Deployment</h2>
    
            <p>
    Now we can deploy a demo project into the domain. I have created a simple project located at:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>https://github.com/liweinan/cluster-demo</code></pre>
        </div>
    </div>
            <p>
    We can use git command to fetch a copy of the demo:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>git clone git://github.com/liweinan/cluster-demo.git</code></pre>
        </div>
    </div>
            <p>
    In this demo project we have a very simple web application. In web.xml we've enabled session replication by adding following entry:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;distributable/&gt;</code></pre>
        </div>
    </div>
            <p>
    And it contains a jsp page called put.jsp which will put current time to a session entry called 'current.time':            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;%
    session.setAttribute(&quot;current.time&quot;, new java.util.Date());
%&gt;</code></pre>
        </div>
    </div>
            <p>
    Then we could fetch this value from get.jsp:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>The time is &lt;%= session.getAttribute(&quot;current.time&quot;) %&gt;</code></pre>
        </div>
    </div>
            <p>
    It's an extremely simple project but it could help us to test the cluster later: We will access put.jsp from cluster and see the request are distributed to master, then we disconnect master and access get.jsp. We should see the request is forwarded to slave but the 'current.time' value is held by session replication. We'll cover more details on this one later.            </p>
                <p>
    Let's go back to this demo project. Now we need to create a war from it. In the project directory, run the following command to get the war:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>mvn package</code></pre>
        </div>
    </div>
            <p>
    It will generate cluster-demo.war. Then we need to deploy the war into domain. First we should access the http management console on master(Because master is acting as domain controller):            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://10.211.55.7:9990</code></pre>
        </div>
    </div>
            <p>
    It will popup a windows ask you to input account name and password, we can use the 'admin' account we've added just now. After logging in we could see the 'Server Instances' window. By default there are three servers listed, which are:            </p>
    <ul class="alternate "><li class=" ">            <p>
    server-one            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    server-two            </p>
    </li></ul><ul class="alternate "><li class=" ">            <p>
    server-three            </p>
    </li></ul>            <p>
    We could see server-one and server-two are in running status and they belong to main-server-group; server-three is in idle status, and it belongs to other-server-group.            </p>
                <p>
    All these servers and server groups are set in domain.xml on master as7. What we are interested in is the 'other-server-group' in domain.xml:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;server-group name=&quot;other-server-group&quot; profile=&quot;ha&quot;&gt;
   &lt;jvm name=&quot;default&quot;&gt;
       &lt;heap size=&quot;64m&quot; max-size=&quot;512m&quot;/&gt;
   &lt;/jvm&gt;
   &lt;socket-binding-group ref=&quot;ha-sockets&quot;/&gt;
&lt;/server-group&gt;</code></pre>
        </div>
    </div>
            <p>
    We could see this server-group is using 'ha' profile, which then uses 'ha-sockets' socket binding group. It enable all the modules we need to establish cluster later(including infinispan, jgroup and mod_cluster modules). So we will deploy our demo project into a server that belongs to 'other-server-group', so 'server-three' is our choice.            </p>
        <div class="confbox admonition admonition-note">
        
            <p>
    In newer version of WildFly, the profile 'ha' changes to 'full-ha':            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;server-group name=&quot;other-server-group&quot; profile=&quot;full-ha&quot;&gt;</code></pre>
        </div>
    </div>
    </div>
    
            <p>
    Let's go back to domain controller's management console:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://10.211.55.7:9990</code></pre>
        </div>
    </div>
            <p>
    Now server-three is not running, so let's click on 'server-three' and then click the 'start' button at bottom right of the server list. Wait a moment and server-three should start now.            </p>
                <p>
    Now we should also enable 'server-three' on slave: From the top of menu list on left side of the page, we could see now we are managing master currently. Click on the list, and click 'slave', then choose 'server-three', and we are in slave host management page now.            </p>
                <p>
    Then repeat the steps we've done on master to start 'server-three' on slave.            </p>
        <div class="confbox admonition admonition-note">
        
            <p>
    server-three on master and slave are two different hosts, their names can be different.            </p>
        </div>
    
            <p>
    After server-three on both master and slave are started, we will add our cluster-demo.war for deployment. Click on the 'Manage Deployments' link at the bottom of left menu list.            </p>
                <p>
        <img src="images/author/download/attachments/66322836/871748299.png" alt="images/author/download/attachments/66322836/871748299.png" />
    <br/>(We should ensure the server-three should be started on both master and slave)            </p>
                <p>
    After enter 'Manage Deployments' page, click 'Add Content' at top right corner. Then we should choose our cluster-demo.war, and follow the instruction to add it into our content repository.            </p>
                <p>
    Now we can see cluster-demo.war is added. Next we click 'Add to Groups' button and add the war to 'other-server-group' and then click 'save'.            </p>
                <p>
    Wait a few seconds, management console will tell you that the project is deployed into 'other-server-group'.&#65306;            </p>
                <p>
        <img src="images/author/download/attachments/66322836/231495614.png" alt="images/author/download/attachments/66322836/231495614.png" />
                </p>
                <p>
    Please note we have two hosts participate in this server group, so the project should be deployed in both master and slave now - that's the power of domain management.            </p>
                <p>
    Now let's verify this, trying to access cluster-demo from both master and slave, and they should all work now:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://10.211.55.7:8330/cluster-demo/</code></pre>
        </div>
    </div>
            <p>
        <img src="images/author/download/attachments/66322836/1222785376.png" alt="images/author/download/attachments/66322836/1222785376.png" />
                </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://10.211.55.2:8330/cluster-demo/</code></pre>
        </div>
    </div>
            <p>
        <img src="images/author/download/attachments/66322836/-1028060795.png" alt="images/author/download/attachments/66322836/-1028060795.png" />
                </p>
                <p>
    Now that we have finished the project deployment and see the usages of domain controller, we will then head up for using these two hosts to establish a cluster     <img src="images/author/images/icons/emoticons/109556488.gif" alt="images/author/images/icons/emoticons/109556488.gif" />
            </p>
        <div class="confbox admonition admonition-note">
        
            <p>
    Why the port number is 8330 instead of 8080? Please check the settings in host.xml on both master and slave:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;server name=&quot;server-three&quot; group=&quot;other-server-group&quot; auto-start=&quot;false&quot;&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset=&quot;250&quot;/&gt;
&lt;/server&gt;</code></pre>
        </div>
    </div>
            <p>
    The port-offset is set to 250, so 8080 + 250 = 8330            </p>
        </div>
    
            <p>
    Now we quit the WildFly process on both master and slave. We have some work left on host.xml configurations. Open the host.xml of master, and do some modifications the servers section from:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;server name=&quot;server-three&quot; group=&quot;other-server-group&quot; auto-start=&quot;false&quot;&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset=&quot;250&quot;/&gt;
&lt;/server&gt;</code></pre>
        </div>
    </div>
            <p>
    to:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;server name=&quot;server-three&quot; group=&quot;other-server-group&quot; auto-start=&quot;true&quot;&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset=&quot;250&quot;/&gt;
&lt;/server&gt;</code></pre>
        </div>
    </div>
            <p>
    We've set auto-start to true so we don't need to enable it in management console each time WildFly restart. Now open slave's host.xml, and modify the server-three section:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>&lt;server name=&quot;server-three-slave&quot; group=&quot;other-server-group&quot; auto-start=&quot;true&quot;&gt;
    &lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;
    &lt;socket-bindings port-offset=&quot;250&quot;/&gt;
&lt;/server&gt;</code></pre>
        </div>
    </div>
            <p>
    Besides setting auto-start to true, we've renamed the 'server-three' to 'server-three-slave'. We need to do this because mod_cluster will fail to register the hosts with same name in a single server group. It will cause name conflict.            </p>
                <p>
    After finishing the above configuration, let's restart two as7 hosts and go on cluster configuration.            </p>
        </div>
    
    <div class="section-2"  id="66322836_WildFly8ClusterHowto-ClusterConfiguration"  >
        <h2>Cluster Configuration</h2>
    
            <p>
    We will use mod_cluster + apache httpd on master as our cluster controller here. Because WildFly 8 has been configured to support mod_cluster out of box so it's the easiest way.            </p>
        <div class="confbox admonition admonition-note">
        
            <p>
    The WildFly 8 domain controller and httpd are not necessary to be on same host. But in this article I just install them all on master for convenience.            </p>
        </div>
    
            <p>
    First we need to ensure that httpd is installed:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>sudo yum install httpd</code></pre>
        </div>
    </div>
            <p>
    And then we need to download newer version of mod_cluster from its website:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://www.jboss.org/mod_cluster/downloads</code></pre>
        </div>
    </div>
            <p>
    The version I downloaded is:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://downloads.jboss.org/mod_cluster/1.1.3.Final/mod_cluster-1.1.3.Final-linux2-x86-so.tar.gz</code></pre>
        </div>
    </div>
    <div class="confbox admonition admonition-note">
        
            <p>
    Jean-Frederic has suggested to use mod_cluster 1.2.x. Because 1.1.x it is affected by CVE-2011-4608            </p>
                <p>
    With mod_cluster-1.2.0 you need to add EnableMCPMReceive in the VirtualHost.            </p>
        </div>
    
            <p>
    Then we extract it into:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>/etc/httpd/modules</code></pre>
        </div>
    </div>
            <p>
    Then we edit httpd.conf:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>sudo vi /etc/httpd/conf/httpd.conf</code></pre>
        </div>
    </div>
            <p>
    We should add the modules:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>LoadModule slotmem_module modules/mod_slotmem.so
LoadModule manager_module modules/mod_manager.so
LoadModule proxy_cluster_module modules/mod_proxy_cluster.so
LoadModule advertise_module modules/mod_advertise.so</code></pre>
        </div>
    </div>
            <p>
    Please note we should comment out:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>#LoadModule proxy_balancer_module modules/mod_proxy_balancer.so</code></pre>
        </div>
    </div>
            <p>
    This is conflicted with cluster module. And then we need to make httpd to listen to public address so we could do the testing. Because we installed httpd on master host so we know the ip address of it:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>Listen 10.211.55.7:80</code></pre>
        </div>
    </div>
            <p>
    Then we do the necessary configuration at the bottom of httpd.conf:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code># This Listen port is for the mod_cluster-manager, where you can see the status of mod_cluster.
# Port 10001 is not a reserved port, so this prevents problems with SELinux.
Listen 10.211.55.7:10001
# This directive only applies to Red Hat Enterprise Linux. It prevents the temmporary
# files from being written to /etc/httpd/logs/ which is not an appropriate location.
MemManagerFile /var/cache/httpd

&lt;VirtualHost 10.211.55.7:10001&gt;

  &lt;Directory /&gt;
    Order deny,allow
    Deny from all
    Allow from 10.211.55.
  &lt;/Directory&gt;


  # This directive allows you to view mod_cluster status at URL http://10.211.55.4:10001/mod_cluster-manager
  &lt;Location /mod_cluster-manager&gt;
   SetHandler mod_cluster-manager
   Order deny,allow
   Deny from all
   Allow from 10.211.55.
  &lt;/Location&gt;

  KeepAliveTimeout 60
  MaxKeepAliveRequests 0

  ManagerBalancerName other-server-group
  AdvertiseFrequency 5

&lt;/VirtualHost&gt;</code></pre>
        </div>
    </div>
    <div class="confbox admonition admonition-note">
        
            <p>
    For more details on mod_cluster configurations please see this document:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://docs.jboss.org/mod_cluster/1.2.0/html/Quick_Start_Guide.html</code></pre>
        </div>
    </div>
    </div>
    
    </div>
    
    <div class="section-2"  id="66322836_WildFly8ClusterHowto-Testing"  >
        <h2>Testing</h2>
    
            <p>
    If everything goes fine we can start httpd service now:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>service httpd start</code></pre>
        </div>
    </div>
            <p>
    Now we access the cluster:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://10.211.55.7/cluster-demo/put.jsp</code></pre>
        </div>
    </div>
            <p>
        <img src="images/author/download/attachments/66322836/-553959633.png" alt="images/author/download/attachments/66322836/-553959633.png" />
                </p>
                <p>
    We should see the request is distributed to one of the hosts(master or slave) from the WildFly log. For me the request is sent to master:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>[Server:server-three] 16:06:22,256 INFO  [stdout] (http-10.211.55.7-10.211.55.7-8330-4) Putting date now</code></pre>
        </div>
    </div>
            <p>
    Now I disconnect master by using the management interface. Select 'runtime' and the server 'master' in the upper corners.            </p>
                <p>
    Select 'server-three' and kick the stop button, the active-icon should change.            </p>
                <p>
    Killing the server by using system commands will have the effect that the Host-Controller restart the instance imediately!            </p>
                <p>
    Then wait for a few seconds and access cluster:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>http://10.211.55.7/cluster-demo/get.jsp</code></pre>
        </div>
    </div>
            <p>
        <img src="images/author/download/attachments/66322836/-409624586.png" alt="images/author/download/attachments/66322836/-409624586.png" />
                </p>
                <p>
    Now the request should be served by slave and we should see the log from slave:            </p>
        <div class="confbox programlisting">
                <div class="content">
        <pre><code>[Server:server-three-slave] 16:08:29,860 INFO  [stdout] (http-10.211.55.2-10.211.55.2-8330-1) Getting date now</code></pre>
        </div>
    </div>
            <p>
    And from the get.jsp we should see that the time we get is the same we've put by 'put.jsp'. Thus it's proven that the session is correctly replicated to slave.            </p>
                <p>
    Now we restart master and should see the host is registered back to cluster.            </p>
        <div class="confbox admonition admonition-note">
        
            <p>
    It doesn't matter if you found the request is distributed to slave at first time. Then just disconnect slave and do the testing, the request should be sent to master instead. The point is we should see the request is redirect from one host to another and the session is held.            </p>
        </div>
    
    </div>
    
    <div class="section-2"  id="66322836_WildFly8ClusterHowto-SpecialThanks"  >
        <h2>Special Thanks</h2>
    
            <p>
    <a href="https://community.jboss.org/people/wdfink">Wolf-Dieter Fink</a> has contributed the updated add-user.sh usages and configs in host.xml from 7.1.0.Final.<br/><a href="https://community.jboss.org/people/jfclere">Jean-Frederic Clere</a> provided the mod_cluster 1.2.0 usages.<br/>Misty Stanley-Jones has given a lot of suggestions and helps to make this document readable.            </p>
        </div>
    
        </div>
    </div>
</body>
</html>
